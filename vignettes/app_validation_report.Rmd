---
title: "Validation Report"
subtitle: "ClinSight"
date: today
format: 
  docx:
    toc: true
    toc-depth: 2
    reference-doc: word_template/template.docx
    number-sections: true
  html:
    code-fold: true
    toc: true
    embed-resources: true
    page-layout: article
    number-sections: true
  pdf: 
    toc: true
    number-sections: true
    header-includes:
      \usepackage{fancyhdr}
      \usepackage{graphicx}
      \usepackage[bottom=3.5cm]{geometry}
params: 
  test_results: "test_results.rds"
vignette: >
  %\VignetteIndexEntry{Unit test report}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
    canonical: true
bibliography: references.bib
---

```{=latex}
\addtolength{\headheight}{0.5cm} 
\fancypagestyle{plain}{} 
\pagestyle{fancy} 
\fancyhead[R]{\includegraphics[height=30pt, width=135pt]{gcp_logo.png}}
\fancyfoot{}
\fancyfoot[R]{\thepage}
\renewcommand{\headrulewidth}{0pt} 
```
```{r, include = FALSE}
pkg_name <- "clinsight"
library(pkg_name, character.only = TRUE)
# testthat should be loaded to convert results to a data frame with the internal 
# function testthat:::as.data.frame.testthat_results
library(testthat)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE
) 

summarize_results <- function(results) {
  results |>  dplyr::summarise(across(where(is.numeric), sum)) |>  knitr::kable()
}
write_results <- function(results) {
  purrr::pwalk(list(results$file, results$Categories), write_file_results)
}
write_file_results <- function(file, categories, ...) {
  cat("###", file, paste0("{#", file, "}"), "\n")
  purrr::pwalk(list(categories$context, categories$Results), write_category_results)
}
write_category_results <- function(category, tests, ...) {
  cat("####", category, "\n")
  
  if (knitr::is_latex_output() ) {
    tab <- knitr::kable(tests, booktabs = TRUE)  |>
      kableExtra::kable_styling() |>
      kableExtra::column_spec(1, width = "30em")
  } else{
    if(knitr::is_html_output()){
       tab <- knitr::kable(tests, booktabs = TRUE)  |>
      kableExtra::kable_styling(full_width = TRUE) |>
      kableExtra::column_spec(1, width = "30em")
    } else{  
      tab <- knitr::kable(tests) 
      }
  } 
  print(tab)
  cat("\n")
}

#load tests 
tests <- if(file.exists(params$test_results)){
  readRDS(params$test_results)
} else{
  get_test_results(package = pkg_name, outfile = params$test_results)
}

```

# Purpose

This Software Validation Document serves as a comprehensive guide
outlining the validation procedures and criteria for the clinical data
visualization application, referred to as "ClinSight". The document aims
to ensure the accuracy, reliability, and compliance of the application
with regulatory standards, thereby validating its functionalities and
features.

## Scope

This report applies to the basic setup of the application for use within
clinical trials.

## Execution and responsibilities

The validation will be executed by Leonard Samson and Thomas Kissner.

## Acceptance Criteria

Passing all tests stated below provides sufficient evidence that the
system complies with the corresponding requirement specification.

# App specification

## Risk Assessment

Risk assessment is performed and described in detail in the
applications' validation plan (MM Application - Software Validation Plan
v0.4). The application falls under the GAMP category 5, 'Custom
applications and components'.

## General constraints

1.  The application is developed within Mozilla Firefox (v121.0) and
    validated with Google Chrome (129.0.6668.60). Although all major
    browsers (Google Chrome, Mozilla Firefox, Safari, Microsoft Edge)
    released after 2013 should work with the application (if they
    support [Websockets](https://caniuse.com/websockets)), it cannot be
    guaranteed that the layout is exactly as intended in browsers other
    than Mozilla Firefox and Google
2.  The application is deployed in a secure environment that is only
    accessible through a VPN.

## General requirements

|     | Requirement                                                                                                                                                                                                                                                                                                                                                       | Validation proof                                                                                                                                                                                                                |
|-----------------|-----------------------------------|---------------------|
| 1   | Secure Authentication and Authorization: the application should have a robust user authentication system with secure password management and role-based access control to ensure that only authorized users, such as medical monitors and data managers, can access sensitive clinical trial data data.                                                           | *Secure authentication for accessing the virtual machine is validated in the deployment validation document. Validation of authentication within the application can be found here: [app_authentication](#app_authentication).* |
| 2   | File Integration/loading data: Can processes raw data in the form of CSV files downloaded from the applicable external EDC system. The data in the application, including the data in the local database, should be updated accordingly.                                                                                                                          | Tested in [Feature 4](#app_feature_04) and in the tests for [loading appdata](#fct_appdata), [*creating* *and updating the database*](#fct_SQLite) *, and [updating review data](#update_review_data).*                         |
| 3   | Data Visualization Tools: Has interactive and user-friendly data visualization tools to present complex medical data in a comprehensible manner, enabling monitors to make informed judgments based on the medical context and in alignment with various medical aspects such as potential (serious) adverse events, concomitant medications and medical history. | Main modules: [Common Forms](#common-forms), [Study Forms](#study-forms), [Timeline](#timeline).                                                                                                                                |
| 4   | Data highlighting: it can highlight data that has not yet been reviewed.                                                                                                                                                                                                                                                                                          | Main modules: [Common Forms](#common-forms), [Study Forms](#study-forms).                                                                                                                                                       |
| 5   | Classification of continuous values: it can visualize classification of a value based on available metadata in the EDC.                                                                                                                                                                                                                                           | Main module: [Study Forms](#study-forms).                                                                                                                                                                                       |
| 6   | Navigation functionality: Allows users to quickly browse to specific patients, to filter on review status, and to browse to a selected form, enhancing overall efficiency.                                                                                                                                                                                        | Main modules: [Navigate Review](#navigate-review), [Navigate Participants](#navigate-participants), [Go to Form](#go-to-form), [Start page](#start-page), [App sidebar](#app-sidebar), [Header widgets](#header-widgets).       |
| 7   | Query Management System: Contains a system for creating, tracking, and managing queries.                                                                                                                                                                                                                                                                          | Main modules: [Add Query](#add-query)*,* [Add Query Follow-up](#add-query-follow-up), [View Queries](#view-queries).                                                                                                            |
| 8   | Reviewing functionality: the application contains a system to perform review per pre-defined study form, and includes a system to show which data has been reviewed before, which is newly entered, and which was already reviewed in a previous review session by the user.                                                                                      | Main modules: [Review Forms](#study-forms), [Review Configuration](#review-configuration).                                                                                                                                      |
| 9   | Reporting functionality: Enable the generation of reports that summarize reviewed visits, items, and open queries, providing a comprehensive overview for both medical monitors and study members (e.g. project managers, data mangers, etc.)                                                                                                                     | Main module: [Create Report](#create-report).                                                                                                                                                                                   |
| 10  | Audit Trail: Contains an audit trail to log all reviewing activities within the app, ensuring accountability and traceability of actions performed.                                                                                                                                                                                                               | Main module: [Add review](#add-review), [Add Query](#add-query)*,* [Add Query Follow-up](#add-query-follow-up).                                                                                                                 |

### Risk classification and mitigation

All hazards classified as low-risk priority in the validation plan do
not need additional risk strategies. All hazards classified as
medium-risk priority or high-risk priority are mentioned below,
including their additional risk mitigation strategies.

**High-risk priority:**

1b) Access possible and granted to a user that is unauthorized.

-   Risk mitigation: We are using the authentication standard OpenID
    Connect to ensure secure authentication, in combination with
    Microsoft Entra ID as secure identity and access management system
    in order to authenticate users and prevent unauthorized access.

8a) The application fails to save a review in the database but not in
the application itself.

-   Risk mitigation: Additional checks were added in the application to
    verify in-memory data with data in database. Now an error message
    will pop up if there might be an inconsistency with the database
    data. The correct saving of queries in the database is tested in the
    module tests [Add query](#add-query) and [Add query
    follow-up](#add-query-follow-up), and the correct saving of review
    data is tested in the module tests [Add review](#add-review).

8b) The application saves a review action incorrectly.

-   Risk mitigation: Mitigated by testing two scenarios in the module
    tests of module [Add review](#add-review). The risk is further
    mitigated by testing an end-to-end test ([Feature 2 (Save
    review)](#app_feature_02)) .

**Medium-risk priority**

2c) The application fails to update the data.

-   Risk mitigation:
    -   Mitigated by testing the functions for [loading
        appdata](#fct_appdata), [*creating* *and updating the
        database*](#fct_SQLite) *, and [updating review
        data](#update_review_data).*
    -   An additional feature was implemented to increase the visibility
        of the database age. Now it is shown in the sidebar when the
        last EDC synchronization took place. In addition, a warning will
        be shown if the database synchronization is more than one day
        old. See [mod_db_synch_info](#mod_db_synch_info).

4a) New or updated data is not highlighted and 4b) Wrong data is
highlighted

-   Risk mitigation: Highlighting is performed in the modules [Common
    forms](#common-forms) and [Study forms](#study-forms). The tests of
    these modules, including their results, can be found
    [here](#mod_common_forms) and [here](#app_feature_1).

7b) A silent error occurs when attempting to save a query, the query is
not saved to the database.

-   Risk mitigation: The application is now improved by verifying
    whether the query in the database is saved correctly and giving user
    feedback if this is not the case. Saving queries is tested in the
    tests for modules [Add query](#add-query) and [Add query
    follow-up](#add-query-follow-up).

10a) The audit trail is not saved properly in the database.

-   Risk mitigation: No data will be overwritten and therefore the
    database serves as an audit trail. Original entries cannot be
    overwritten or edited from within the application. The risk of
    incorrectly data in the database is mitigated by testing the
    following modules: [Review Forms](#mod_review_forms), [Add
    Query](#add-query)*,* [Add Query Follow-up](#add-query-follow-up),
    and by testing the following functions that are used in these
    modules: [db_save_review](#db_save_review), [db_save](#db_save).

# App module specification

In this section, the main modules of the application, including their
function, are described.

## App sidebar (mod_main_sidebar) {#app-sidebar}

*Applicable requirements: 6) Navigation functionality.*

This sidebar contains the main controls for the application. In the
sidebar, a panel is available which allows the user to apply a review to
the active form and patient (forms can be marked as reviewed, a comment
can be added, and the review can be saved. In addition, it contains
buttons to navigate to the next/previous forms and to add a query to the
active form.

-   Link to module tests and test results :
    [`mod_main_sidebar`](#mod_main_sidebar).

## Header widgets (mod_header_widgets) {#header-widgets}

*Applicable requirements: 6) Navigation functionality.*

The value boxes in this module contain information about the active
user. They show the patient id, the patient status (active/inactive
participant), the number of adverse events (with a color code showing
whether any new or updated data is available), the number of forms that
need a review, and a timeline figure showing the number of visits that
the patient performed. The value box with adverse events also serves as
a link to the adverse events form. Furthermore, clicking on the box with
forms to review will trigger 'mod_navigate_review(), and opens a
secondary modal window that shows the forms that need review and the
queries that are open of the active participant, to which you can
directly navigate to.

-   Link to module tests and test results :
    [`mod_header_widgets`](#mod_header_widgets).

## Start page (mod_start_page) {#start-page}

*Applicable requirements: 6) Navigation functionality.*

Start page of the main application. The start page contains navigation
buttons and a table that shows one row per patient. The table shows
general study information such as study status (active or inactive
participant), main diagnosis, age, sex, number of conducted study
visits, and the patient's data status (new data, updated data, or old
data). In addition, in the module there are two navigation options.
First, the user can navigate to the selected patient directly. Secondly,
the user can indirectly call the module 'mod_navigate_review_server()'
to open a modal in which all the forms are shown that need review of the
selected patient. navigate to patient that is currently highlighted.
highlighted to a participant study and options to navigate directly to
the selected forms/patients n the overview tables.

-   Link to module tests and test results :
    [`mod_start_page`](#mod_start_page).

## Common Forms (mod_common_forms) {#common-forms}

*Applicable requirements: 3) Data visualization tools, 4) Data
highlighting.*

The module displays tables of common form data in a wide format.
Included common forms are: `⁠Adverse events⁠`, `⁠Medical History⁠`,
`Medication`, and `⁠Conc. Procedures⁠`. The applicable forms can be
flexibly changed in the metadata. The tables shown are overview tables
in wide format, similar to the ones in mod_study_forms(). When the
common form ⁠Adverse events⁠ is selected, the module will show an
additional table with Severe Adverse Events above the table with Adverse
Events. In addition, it will show a timeline by calling module
`mod_timeline`. The timeline shows study events (such as drug
administrations) and study visits together with Adverse Events, so that
temporal relationships between these events can be quickly revealed. The
⁠common forms⁠ module is used in the main server to create all applicable
common forms with an `apply()` loop.

-   Link to module tests and test results :
    [`mod_common_forms`](#mod_common_forms),
    [`mod_timeline`](#mod_timeline).

## Timeline (mod_timeline) {#timeline}

*Applicable requirements: 3) Data visualization tools.*

Lower level module, used within mod_common_forms, to create a timeline
with important study-related events such as (serious) adverse events,
and study drug administration.

-   Link to module tests and test results: [mod_timeline](#mod_timeline)

## Study Forms (mod_study_forms) {#study-forms}

*Applicable requirements: 3) Data visualization tools, 4) Data
highlighting, 5) Classification of continuous values.*

Used to display figures and tables of a study-specific form and will be
accessible in through the study form tab on the main page. The module
displays tables and figures and shows data of the currently active
subject. In the figures, the data can easily be compared with data of
other study participants. Data that is new or updated will have large
points, so that the reviewer can focus on new data. By default, all
items of a form will be shown, but the reviewer can select single or
multiple variables to focus on in the figure. There is also an option to
switch from graphical view to table view. In a table view, the same data
will be shown in wide-table format, with new/updated data shown in bold.
If the values contain units, the original units will be shown. The ⁠Study
forms⁠ module is used in the main `app_server()` to create all applicable
study form pages.

-   Link to module tests and test results :
    [`mod_study_forms`](#mod_study_forms).
-   Important lower-level functions: [*fig_timeline*](#fig_timeline)*,
    [fig_boxplots](#fig_boxplots), [fig_timeseries](#fig_timeseries).*

## Navigate review tables (mod_navigate_review) {#navigate-review}

*Applicable requirements: 6) Navigation functionality.*

Used to display all data that needs review and all queries that are
still open. It enables the user to directly navigate to a specific form
or patient. The module will be called from the main server and will open
a modal with two tables: a table with forms that need to be reviewed and
a table with queries that are raised. There is a switch in the modal,
which can toggle the tables to only show data of the currently active
and selected participant, or to show data of all the participants that
need to be reviewed. There is a button to navigate to the form of a
selected data frame. Once clicked, this will activate the module
'mod_go_to_form_server()', which is a low-level helper module to change
the active participant and active review form to the one in the selected
table row.

-   Link to module tests and test results :
    [`mod_navigate_review`](#mod_navigate_review).

## Navigate participants (mod_navigate_participants) {#navigate-participants}

*Applicable requirements: 6) Navigation functionality.*

Used to show participant information in a `valuebox` in the header of
the application. By clicking on the `valuebox`, additional participant
information will be shown, as well as a selection menu to select a
different subject. Once the subject is changed, the active `subject_id`
will be changed in the application.

Link to module tests and test results :
[`mod_navigate_participants`](#mod_navigate_participants).

## Navigate Forms (mod_navigate_forms) {#navigate-forms}

*Applicable requirements: 6) Navigation functionality.*

Shiny server module to navigate between forms. Navigation is done with a
`back` and `forward` button in the UI module.

-   Link to module test and test results:
    [mod_navigate_forms](#mod_navigate_forms)

## Go to Form (mod_go_to_form) {#go-to-form}

*Applicable requirements: 6) Navigation functionality.*

Lower-level module, used within multiple higher-level modules to
navigate to a specific form.

-   Link to module tests and test results :
    [mod_go_to_form](#mod_go_to_form).

## View queries (mod_queries) {#view-queries}

*Applicable requirements: 7) Query Management System.*

Used to display all raised queries in a table. Upon clicking on a query,
the query follow-up messages will be shown. In addition, it will be
possible to write a follow-up message. The logic for writing the
follow-up message is extracted in a different module, [Add Query
Follow-up](#add-query-follow-up). New queries are created in the module
[Add query](#add-query). The button to initiate this module can be found
in the main sidebar [App sidebar](#app-sidebar).

-   Link to module tests and test results :
    [`mod_queries`](#mod_queries).

## Add query (mod_query_add) {#add-query}

*Applicable requirements: 7) Query Management System, 10) Audit trail.*

Used to create a new query and add it to the database. This module can
be activated by pressing an action button, which is currently located in
the [App sidebar](#app-sidebar). Upon activation of this module, a
window will be shown with a fixed sidebar and a field with the main
content. The main content contains a field in which a query can be
written, contains a `Save` and `Cancel` button, and shows the name of
the reviewer who is currently logged in. In the sidebar, information is
given about the currently active patient and form. In addition,
drop-down menus are shown to narrow down to which data the query is
concerning. In these menus, the applicable visit, and (optional) the
applicable item within the form can be selected.

-   Link to module tests and test results :
    [`mod_query_add`](#mod_query_add).

## Add query follow-up (mod_query_follow_up) {#add-query-follow-up}

*Applicable requirements: 7) Query Management System, 10) Audit trail.*

Used to add a follow-up message to a query and save it to the
application database.

-   Link to module tests and test results :
    [`mod_query_follow_up`](#mod_query_follow_up)

## Add Review (mod_review_forms) {#add-review}

*Applicable requirements: 8) Reviewing functionality, 10) Audit trail.*

Used to mark data as reviewed and add comments to data of a specific
form/page in the database and in the internal application data. This
module is initialized in the [App sidebar](#app-sidebar). It is used to
display whether the form that is actively being displayed in the
application has any values that are newly entered or updated since the
last review session. In addition, if a page contains new data, the user
can mark all data in the form as being reviewed and can (optionally) add
a comment to this review action. The data will be saved in a database.
All review activity is stored with an audit-trail, with date/time stamps
and with the reviewer's name.

-   Link to module tests and test results :
    [`mod_review_forms`](#mod_review_forms)
-   Important underlying functions: [get_review_data](#get_review_data),
    [update_review_data](#update_review_data),
    [summarize_review_data](#summarize_review_data),
    [collapse_column_vals](#collapse_column_vals).
-   Important underlying functions for database handling:
    [*`db_save`*](#fct_SQLite)*, [`db_create`](#fct_SQLite),
    [`db_save_review`](#fct_SQLite),
    [`update_review_data`](#fct_SQLite),
    [db_slice_rows](#db_slice_rows)*,
    [collect_query_data](#collect_query_data).

## Review Configuration (mod_review_config)

*Applicable requirements: 8) Reviewing functionality.*

Used to set the desired review configuration for the active user. When
the module is called from the main server, it will show options to
select regions and sites of interest to the user. The user sets these
filters at the beginning of their session, to select the study sites
that need review. After selecting the appropriate filter settings and
confirming the review by clicking on the confirm review button, the
internal data sets will be filtered on the selected filter settings and
only the selected data will be shown in the application.

-   Link to module tests and test results :
    [`mod_review_config`](#mod_review_config).

## Create Report (mod_report) {#create-report}

*Applicable requirements: 9) Reporting functionality.*

Used to create PDF reports of all the reviewing activities in the
application.

-   Link to module tests and test results : [`mod_report`](#mod_report).
-   Important lower-level functions:
    [`create_report`](#mod_report_fct_helpers)*.*

# App validation - General

## Software

The application is build using `R`, which is an open-source language and
environment for statistical computing and graphics
[@rcoreteamlanguage2023]. The application is embedded within a
custom-made R package. The interactive visual layer is created using the
`shiny` package [@shiny]. The application is developed following the
[common guidelines of developing R packages](https://r-pkgs.org/)
[@wickhamRPackages2023], and guidelines of creating production-ready
shiny applications [@fayEngineering2022] using the `golem` framework
around the `shiny` package [@faygolem2023].

## R packages

The packages of which functions are used directly within the application
are mentioned below, including their risk classification. The risk
classification is performed and documented according to our guideline ''
The use of R and R packages within a GxP environment" (GMP_XXX\_, under
development, draft available here: Z:\\RValidation\\01. Documentation).

| Package           | Version                            | Use case                                           | Risk classification |
|----------------|----------------|-----------------------|----------------|
| `bslib`           | `r packageVersion("bslib")`        | Application interface                              | Low risk            |
| `config`          | `r packageVersion("config")`       | Application interface                              | Low risk            |
| `DBI`             | `r packageVersion("DBI")`          | Data input/output                                  | Low risk            |
| `dplyr`           | `r packageVersion("dplyr")`        | Data wrangling                                     | Low risk            |
| `dbplyr`          | `r packageVersion("dbplyr")`       | Data wrangling, data input/output                  | Low risk            |
| `DT`              | `r packageVersion("DT")`           | Visualization                                      | Low risk            |
| `ggplot2`         | `r packageVersion("ggplot2")`      | Visualization                                      | Low risk            |
| `golem`           | `r packageVersion("golem")`        | Application Interface (creating shiny application) | Low risk            |
| `htmltools`       | `r packageVersion("htmltools")`    | Application interface                              | Low risk            |
| `plotly`          | `r packageVersion("plotly")`       | Visualization                                      | Low risk            |
| `rmarkdown`       | `r packageVersion("rmarkdown")`    | Communication                                      | Low risk            |
| `RSQLite`         | `r packageVersion("RSQLite")`      | Data input/output                                  | Low risk            |
| `shiny`           | `r packageVersion("shiny")`        | Application Interface                              | Low risk            |
| `shinycssloaders` | `r packageVersion("shinyjs")`      | Application Interface                              | Low risk            |
| `shinyjs`         | `r packageVersion("shinyjs")`      | Application Interface                              | Low risk            |
| `shinymanager`    | `r packageVersion("shinymanager")` | Credential management                              | Medium risk         |
| `shinyWidgets`    | `r packageVersion("shinyWidgets")` | Shiny user interface                               | Low risk            |
| `tidyr`           | `r packageVersion("tidyr")`        | Data wrangling                                     | Low risk            |
| `timevis`         | `r packageVersion("timevis")`      | Visualization                                      | Low risk            |
| `tools`           | `r packageVersion("tools")`        | Data wrangling                                     | Low risk            |
| `rlang`           | `r packageVersion("rlang")`        | Data wrangling                                     | Low risk            |
| `withr`           | `r packageVersion("withr")`        | Data handling                                      | Low risk            |

### Medium-risk R packages

#### Package name

`shinymanager`

#### Rationale for use and risk mitigation

We decided to implement a different authentication methodology based on
OpenID Connect in combination with Microsofts' Identity and Access
Management system 'Microsoft Entra ID (former Azure Active Directory)'.
Therefore, this risk became not applicable.

### High-risk R packages

No high-risk packages were used for this application.

## Source code management

The source code is managed and maintained using
[GIT](https://git-scm.com/), an open-source version control system that
is widely used for software development [@chaconPro2014]. The version
control system ensures that all changes in the source code are
registered in commits, that include a commit message, the editor, and
the date and time of the change. The system also enables to reverse
changes quickly to revert to previous versions if needed.

## Reproducible environment

The application is developed in a fixed environment with R and R package
versions documented and declared, ensuring that the application's
dependencies are consistent and that the application's behavior is fully
reproducible. The reproducible environment was created by using a fixed
R version (`r R.version$version.string`), and by using the `renv`
package (version 1.0.3, developed by POSIT) to maintain consistent
package versions, in combination with the publicly available POSIT
package manager with a snapshot of the public CRAN repository on 17
September 2024 (https://packagemanager.posit.co/cran/2023-09-17).
Furthermore, the application and the environment was made fully
reproducible by creating a custom Docker image using Alpine Linux, in
which all dependencies are fully controlled and managed.

## Documentation

Detailed information about the application and its underlying functions
can be found in the application's R package manual.

## Deployment

The application's deployment will be validated in the installation
qualification documents.

## Secure access

The application will be deployed on a server behind our companies proxy
server. User access is granted and maintained by the IT department of
GCP-Service International, to ensure only authorized personnel has
access to the data and the applications' login page. Users are required
to login the application with their personal login credentials, to
ensure accountability and traceability of all review actions.

### Encryption

Data is secured behind a proxy server and a login management of a remote
desktop environment. Within the remote desktop environment, data is not
encrypted. This is judged as being acceptable, since the data is
adequately protected from access by unauthorized users, and the users
that are authorized (Medical Monitors and Data Managers) are allowed to
gain read access to the clinical trial data.

### Backup

Backups will be created regularly on a daily basis.

## Testing

Testing of the application is done using the package `testthat` edition
3 [@wickham2011; @testthat], and `devtools` [@wickhamdevtools2022],
according to R package development standards and guidelines
[@wickhamRPackages2023]. The tests performed are a combination of unit
tests, testing low-level functions, as well as integration tests,
testing application modules and testing that the modules work as
expected together.

To ensure that the application meets the defined requirements, the tests
for the application were written using a Behavior Driven Development
approach for module and end user tests [@anjum2020;
@binamunguMaintaining2018; @northIntroducing2006]. This structured way
of software development means that the tests are accompanied by feature
descriptions, capturing the expected behavior of the software. The
features are then tested by means of use-case scenarios, which are
described in a consistent manner including detailed descriptions of
preconditions and setting and expectations under these conditions.

## Standard module UI and server tests

Testing of every module starts with testing that that the UI and server
can load in isolation without any problems. These tests are standardized
and are an addition to the Behavior Drive Development described above.
If these tests pass successfully, they provide evidence that the basic
requirements of the modules, with their basic functionality working as
intended.

The description for the UI standardized UI test is:

> Can load the module UI, with functioning internal parameters.

This scenario tests that the UI function outputs the expected defined
format (for example, a `r shiny::tagList()` object), and that the id
argument is available. The id argument connects the UI with the server.

The description of the standardized module server test is:

> Can load the module server, with functioning internal parameters.

This scenario tests that the module server function runs. More
specifically, it tests whether the namespacing function `ns` exists, the
namespacing function outputs the expected prefix, and whether the
namespacing id is included in the final id tag.

```{r , warning=F, message=FALSE}
# The S3 method testthat:::as.data.frame.testthat_results should be available
# to run the following without error
test_results <- tests$results |> 
  dplyr::as_tibble() |> 
  dplyr::rename(Test = test) |> 
  dplyr::mutate(
  #  Test = gsub("\n", "", Test), #since new lines mess up markdown tables
    context = stringr::str_extract(
      gsub("\n", "", Test), 
      pattern = "^.+\\:"),
    context = gsub(":", "", context),
    context = ifelse(is.na(context), "", context),
    Test = gsub("^.+\\:", "", Test),
    Test = gsub("\\$", "\\\\$", Test),
    file = gsub("test-", "", file),
    file = gsub(".R", "", file)
  ) |> 
  dplyr::summarize(
    N        = dplyr::first(nb),
    Passed   = sum(passed),
    Failed   = sum(failed),
    Warnings = sum(warning),
    Errors   = sum(as.numeric(error)),
    Skipped  = sum(as.numeric(skipped)),  
    .by = c(file, context, Test)
  ) 


results_grouped <- test_results |> 
  dplyr::mutate(Test = gsub("\n", "", Test)) |> 
  tidyr::pivot_longer(-c(file, context, Test, N)) |> 
  dplyr::filter(value != 0) |> 
  dplyr::mutate(
    Result = ifelse(
      value == N, 
      name, 
      paste0(name, "(N=", value, ")")
    )
  ) |> 
  dplyr::select(-c(name, value)) |> 
  collapse_column_vals("Result", group_by = c("file", "context", "Test")) |> 
  dplyr::distinct()

results_nested <- results_grouped |> 
  tidyr::nest( .by = c(file, context), .key = "Results") |> 
  tidyr::nest( .by = file, .key = "Categories")

results_modules <- results_nested |> 
  dplyr::filter(grepl("mod_", file))

results_functions <- results_nested |> 
  dplyr::filter(
    !grepl("mod_", file) & 
      !grepl("app_authentication", file) & 
      !grepl("app_feature_", file)
    )

results_system <- results_nested |> 
  dplyr::filter(grepl("app_authentication", file) | grepl("app_feature_", file))

all_tests_passed <- ( sum(test_results$Passed) == sum(test_results$N) ) && 
  sum(test_results$Errors) == 0
conclusion <- if(all_tests_passed){
 "Acceptance criteria according to test plan are met. Validation successful."
} else ("Not all tests passed without problems.")
```

# Application Test report

Created on: `r tests$time`.

## Test Summary

**`r conclusion`**

```{r , results='asis'}
summarize_results(test_results)
```

## Test environment

Tests were run in the following environment:

```{r}
tests$session
```

## End-to-end tests

These are the tests and test results of testing the entire application
end-to-end.

```{r , results='asis'}
write_results(results_system)
```

## Module tests

These are the tests and test results of the application's modules.

```{r , results='asis'}
write_results(results_modules)
```

## Function tests

These are tests and test results of lower-level functions (units) that
are used within the application modules.

```{r , results='asis'}
write_results(results_functions)
```

# References
